#!/usr/bin/perl

# When converting markdown to HTML, pandoc puts the table of contents at the
# beginning.  Use a custom template to wrap the TOC with a <nav id="TOC"> tag,
# then pipe through this script to move it to the first <tocHere> tag.

use warnings;
use strict;

my @toc;
my $tocF = 0;

while (<>) {
  $tocF = 1 if /^<nav id="TOC">/;
  push(@toc, $_) if $tocF;
  print unless $tocF;
  $tocF = 0 if m!^</nav>!;
  if (m!<tocHere/>!) {
    my $preF = 1;
    print shift @toc;
    print "<ul>\n";
    foreach my $line (@toc) {
#      print "preF=$preF, line=$line";
      print $line if $preF == 0;
      $preF = 2 if $preF == 1 && $line =~ m!#table-of-contents!;
      $preF = 0 if $preF == 2 && $line =~ m!</li>!;
    }
    print "</ul>\n";
  }
}
